{%- liquid
  comment
    Renders the active filters display.

    Required parameters:
      - resource: { Object } The resource being filtered (ie. collection or search).
      - show_swatch_filters: { Boolean } Whether to show swatch filters.
      - active_filter_count: { Number } The number of active filters.
      - custom_color_key_map: { Object } An array of custom swatch color keys (names).
      - custom_color_value_map: { Object } An array of custom swatch color values (HEX values).

    Optional parameters:
      - wrapper_class: { String } A custom class to apply to the wrapper element.
  endcomment

  assign file_extension = 'png'
  assign swatch_options = settings.swatch_options | downcase | split: ', '
  assign sort_by = resource.sort_by | default: resource.default_sort_by

  if resource.url
    assign results_url = resource.url
  else
    assign terms = resource.terms | escape
    assign results_url = '?q=' | append: terms | append: '&options%5Bprefix%5D=last&sort_by=' | append: sort_by
  endif

  assign container_class = 'active-filters'

  if wrapper_class != blank
    assign container_class = container_class | append: ' ' | append: wrapper_class
  endif
-%}

<div
  class="{{ container_class }}"
  data-active-filters
>
  <div
    class="active-filters-inner"
    data-has-active-filters="{% if active_filter_count > 0 %}true{% else %}false{% endif %}"
  >
    {% for filter in resource.filters -%}
      {%- assign group_name = filter.label | strip | downcase -%}

      {% for value in filter.active_values -%}
        <div class="active-filters__active-filter-wrapper">
          <a
            href="{{ value.url_to_remove }}"
            class="active-filters__active-filter fs-body-100 no-transition"
            data-remove-filter
            data-url-to-remove="{{ value.url_to_remove | split: '?' | last }}"
            data-filter="filter-{{ value.label | handleize | escape }}"
            data-name="{{ value.param_name }}"
            data-value="{{ value.value }}"
            data-value-escaped="{{ value.value | url_escape }}"
          >
            {% if swatch_options contains group_name and show_swatch_filters == true -%}
              {% liquid
                capture filter_swatch_style
                  assign downcased_value = value.label | downcase
                  assign swatch_image_url = blank

                  if value.swatch and value.swatch.color
                    echo 'background-color: [[bc]];' | replace: '[[bc]]', value.swatch.color
                  elsif custom_color_key_map contains downcased_value
                    for color_name in custom_color_key_map
                      if color_name == downcased_value
                        echo 'background-color: [[cc]];' | replace: '[[cc]]', custom_color_value_map[forloop.index0]
                        break
                      endif
                    endfor
                  else
                    assign formatted_value_name = value.label | downcase | replace: ' ', ''
                    echo 'background-color: [[fc]];' | replace: '[[fc]]', formatted_value_name
                  endif

                  if value.swatch and value.swatch.image
                    assign swatch_image_url = value.swatch.image | image_url: width: 36
                  else
                    assign custom_swatch_image = value.label | handle | append: '.' | append: file_extension
                    if images[custom_swatch_image] != blank
                      assign swatch_image_url = custom_swatch_image | file_url
                    endif
                  endif

                  if swatch_image_url != blank
                    echo ' background-image: url([[siu]]);' | replace: '[[siu]]', swatch_image_url
                    echo ' background-position: center; background-size: cover;'
                  endif
                endcapture
              -%}

              <span
                class="active-filters__swatch"
                style="{{ filter_swatch_style }}"
              ></span>
            {%- endif %}

            {% liquid
              if filter.type == 'boolean'
                echo filter.label | escape
              else
                echo value.label | escape
              endif

              render 'icon', icon: 'close-small'
            -%}
          </a>
        </div>
      {%- endfor %}

      {% if filter.type == 'price_range' -%}
        {% if filter.min_value.value != null or filter.max_value.value != null -%}
          <div class="active-filters__active-filter-wrapper">
            <a
              href="{{ filter.url_to_remove }}"
              class="active-filters__active-filter fs-body-100 no-transition"
              data-remove-range
              data-url-to-remove="{{ filter.url_to_remove | split: '?' | last }}"
            >
              {% liquid
                capture min_value
                  if filter.min_value.value
                    echo filter.min_value.value | money
                  else
                    echo filter.range_min | money
                  endif
                endcapture

                capture max_value
                  if filter.max_value.value
                    echo filter.max_value.value | money
                  else
                    echo filter.range_max | money
                  endif
                endcapture

                echo '[[min]] - [[max]]' | replace: '[[min]]', min_value | replace: '[[max]]', max_value

                render 'icon', icon: 'close-small'
              -%}
            </a>
          </div>
        {%- endif -%}
      {% endif %}
    {%- endfor -%}

    <a
      href="{{ results_url }}"
      class="active-filters__active-filter active-filters__clear no-transition btn btn--text-link fs-body-100"
      data-clear-all-filters
    >
      <span>{{ 'filters.clear_all' | t }}</span>
    </a>
  </div>
</div>
